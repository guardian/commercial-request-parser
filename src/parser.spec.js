import { parseGAMRequest, parseYouTubeRequest } from "./parser";

describe('YouTube request parser', () => {
    it('parses a valid request with consent', () => {
        const request = "https://www.youtube.com/embed/AE0xPBXxFkM?modestbranding=1&origin=https%3A%2F%2Fwww.theguardian.com&playsinline=1&rel=0&embed_config=%7B%22relatedChannels%22%3A%5B%5D%2C%22adsConfig%22%3A%7B%22adTagParameters%22%3A%7B%22iu%22%3A%22%2F59666047%2Ftheguardian.com%2Fpolitics%2Fliveblog%2Fng%22%2C%22cust_params%22%3A%22sens%253Df%2526si%253Df%2526vl%253D0%2526cc%253DUK%2526s%253Dpolitics%2526inskin%253Df%2526se%253Dpolitics-live-with-andrew-sparrow%2526ct%253Dliveblog%2526co%253Dandrewsparrow%252Carchie-bland%252Clisaocarroll%2526url%253D%25252Fpolitics%25252Flive%25252F2022%25252Fmay%25252F10%25252Fminister-says-queens-speech-will-tackle-hooligan-protesters-amid-concerns-non-tory-bills-left-out%2526su%253D4%252C5%252C1%252C2%252C3%2526edition%253Duk%2526tn%253Dminutebyminute%252Cnews%2526p%253Dng%2526k%253Deconomy%252Cpolitics%252Cconservatives%252Cqueens-speech%252Cuk%25252Fuk%252Cboris-johnson%252Ctradeunions%252Cnorthernireland%252Cireland%252Ceu-referendum%252Ckeir-starmer%252Clabour%2526sh%253Dhttps%25253A%25252F%25252Fwww.theguardian.com%25252Fp%25252Fydh4n%2526pa%253Df%2526urlkw%253Dminister%252Csays%252Cqueens%252Cspeech%252Cwill%252Ctackle%252Chooligan%252Cprotesters%252Camid%252Cconcerns%252Cnon%252Ctory%252Cbills%252Cleft%252Cout%2526permutive%253D23527%252C24083%252C24089%252C24091%252C24495%252C24509%252C24525%252C24538%252C24558%252C24561%252C24565%252C24566%252C24571%252C24581%252C24583%252C24594%252C24599%252C24601%252C24603%252C24604%252C24605%252C24607%252C24608%252C24611%252C24612%252C24615%252C24616%252C24618%252C24619%252C24624%252C24627%252C24632%252C24633%252C24639%252C24645%252C24646%252C24647%252C24650%252C24652%252C24654%252C24655%252C24656%252C24657%252C24658%252C24659%252C24661%252C24676%252C24677%252C24678%252C24679%252C24680%252C24682%252C24684%252C24686%252C24688%252C24689%252C24690%252C24691%252C24692%252C24693%252C24694%252C24695%252C24699%252C24753%252C24757%252C24763%252C24977%252C24983%252C24984%252C24985%252C25031%252C25061%252C25079%252C25086%252C25180%252C25367%252C25457%252C25471%252C25472%252C25480%252C25484%252C25500%252C26030%252C26130%252C26419%252C26534%252C26749%252C26822%252C27564%252C27592%252C27631%252C28008%252C28478%252C28479%252C28985%252C29249%252C29317%252C29431%252C31044%252C31207%252C31250%252C31251%252C31757%252C31954%252C32322%252C32328%252C32388%252C32484%252C32510%252C32737%252C32738%252C32773%252C33126%252C33129%252C33379%252C33392%252C34312%252C34372%252C37158%252C37344%252C37434%252C37673%252C37751%252C38185%252C39636%252C39994%252C39996%252C40032%252C40123%252C40192%252C40205%252C40271%252C40273%252C40852%252C40961%252C40986%252C42134%252C42135%252C42233%252C43270%252C43272%252C43599%252C43850%252C47026%252C47509%252C47834%252C48018%252C49820%252C50447%252C50932%252C51653%252C52501%252C52698%252C52945%252C52946%252C53104%252C53220%252C53278%252C53290%252C53293%252C53301%252C53793%252C54438%252C54565%252C54759%252C54952%252C55191%252C55237%252C56521%252C56617%252C56792%252C56848%252C57824%252C59453%252C59934%252C60110%252C60164%252C60459%252C60460%252C60722%252C60835%252C60906%252C61623%252C61624%252C61625%252C62154%252C62176%252C62177%252C62332%252C62597%252C62605%252C64286%252C64482%252C64816%252C64866%252C64932%252C66587%252C66654%252C66655%252C67162%252C67163%252C69195%252C69480%252C70011%252C71154%252C73168%252C73169%252C73177%252C74853%252C75241%252C75539%252C75590%252C75667%252C75977%252C76330%252C76453%252C77558%252C77562%252C77683%252C77872%252C79104%252C79116%252C79204%252C79231%252C79492%252C80376%252C80377%252C81084%252C81511%252C81541%252C81748%252C81809%252C81826%252C82082%252C82083%252C82086%252C82087%252C82091%252C82093%252C82098%252C82349%252C82400%252C82401%252C82404%252C82405%252C82406%252C82407%252C82408%252C82409%252C82417%22%2C%22cmpGdpr%22%3A1%2C%22cmpGvcd%22%3A%221~46.1301.70.1843.108.1878.440.3119.1097.196.202.89.2918.149.338.1205.2035.415.1415.2677.482.505.494.486.981.1456.89.2090%22%2C%22cmpVcd%22%3A%22CPTHoTJPTHoTJAGABCENB-CgAP_AAG_AAAQ4IDtB9S7eTWMDeH5_Y7t0cYUX1R5_oeAijgEAF4IBwRKUIIwWEGAyJESIBqACEAYAIiJAIAdkGEAAAEAAYIABAAHIAEAEKAAAIAIEGAABAgIACAAIAAAAEAAQgAAUECAgiAAAcJYgSAAABAAAAAAAAAgEAAAAAgAAAAAAAAAAAAAAACgbRAhAAcABcAEIAOQAfgBkADQAG0ARwAkQBZgC5AHUAO6Ag4CEAERAJ2AT8ApYBbQC6wGAAYEAzIBrADXwHUAdUA7YB_wEPgJiAXaAxYBtAB4yAOAEwARwBHAEnAJiAWwAvMRAGAEMANkA1gB1QEOgMnEAAQASBIEwACwAKgAZAA5AB4AIAAZAA8gCIAIoATAAngBVADmAHoAPwAhABDACIAEcAJYATQApQBbgDZAHsAPgAfoBAwCOAEpANYAcQBDoCYgFsALzAYaAyQBk4QAEACQApYaAQAIYAbMBaAFpANYAdUBDoDGAGTioBAATABHAEcgLQAtICQQExALYAXmOgaAALAAqABkADkAHwAggBiAGQAPAAfQBEAEUAJgATwAqgBdAC-AGIAMwAcwA9AB-AEMAIgARwAlgBMACaAFGAKUAWIAtwBhADRAGyAPYAfoBAwCLAEcAJTAWgBaQC6gF5AOIAdQBDoCQQFsALtAXmAw0BjADJAGTjgAQAJABSEICwACwAMgAxACYAFUAL4AYgAzAB6AEcALEAYQBHACUwFoAWkA6gCQQEnALYAXaAycBwBAACAKQlAfAAWABkADgAHwAYgA8ACIAEwAKoAXwAxABmADaAIYARAAjgBRgClAFuAMIAbIBHIC0ALSAXUA6gCHQFsALtAXmAycBwBIACAKQpAoAAWABUADIAHIAPgBBADEAMgAeQBEAEUAJgATwApABVAC-AGIAMwAcwA_ACGAEQAKMAUoAsQBbgDCAGiANkAfoBFgCOAEpALyAh0BJwC2AF2gLzAYaAxgBkgDJygAIAEgApAAA.YAAAAAAAAAAA%22%7D%2C%22nonPersonalizedAd%22%3Afalse%7D%7D&enablejsapi=1&widgetid=1";
        const parsedRequest = parseYouTubeRequest(request);
        const requestObject = JSON.parse(parsedRequest);
        const embedConfig = requestObject.embed_config;
        const adsConfig = embedConfig.adsConfig;
        const adTagParameters = adsConfig.adTagParameters;
        const custParams = adTagParameters.cust_params;
        // consent
        expect(adTagParameters).toEqual(
            expect.objectContaining({
                // cmpGdpr = consentState.tcfv2.gdprApplies
                cmpGdpr: 1,
                // cmpGvcd = consentState.tcfv2.addtlConsent
                cmpGvcd: "1~46.1301.70.1843.108.1878.440.3119.1097.196.202.89.2918.149.338.1205.2035.415.1415.2677.482.505.494.486.981.1456.89.2090",
                // cmpVcd = consentState.tcfv2.tcString
                cmpVcd: "CPTHoTJPTHoTJAGABCENB-CgAP_AAG_AAAQ4IDtB9S7eTWMDeH5_Y7t0cYUX1R5_oeAijgEAF4IBwRKUIIwWEGAyJESIBqACEAYAIiJAIAdkGEAAAEAAYIABAAHIAEAEKAAAIAIEGAABAgIACAAIAAAAEAAQgAAUECAgiAAAcJYgSAAABAAAAAAAAAgEAAAAAgAAAAAAAAAAAAAAACgbRAhAAcABcAEIAOQAfgBkADQAG0ARwAkQBZgC5AHUAO6Ag4CEAERAJ2AT8ApYBbQC6wGAAYEAzIBrADXwHUAdUA7YB_wEPgJiAXaAxYBtAB4yAOAEwARwBHAEnAJiAWwAvMRAGAEMANkA1gB1QEOgMnEAAQASBIEwACwAKgAZAA5AB4AIAAZAA8gCIAIoATAAngBVADmAHoAPwAhABDACIAEcAJYATQApQBbgDZAHsAPgAfoBAwCOAEpANYAcQBDoCYgFsALzAYaAyQBk4QAEACQApYaAQAIYAbMBaAFpANYAdUBDoDGAGTioBAATABHAEcgLQAtICQQExALYAXmOgaAALAAqABkADkAHwAggBiAGQAPAAfQBEAEUAJgATwAqgBdAC-AGIAMwAcwA9AB-AEMAIgARwAlgBMACaAFGAKUAWIAtwBhADRAGyAPYAfoBAwCLAEcAJTAWgBaQC6gF5AOIAdQBDoCQQFsALtAXmAw0BjADJAGTjgAQAJABSEICwACwAMgAxACYAFUAL4AYgAzAB6AEcALEAYQBHACUwFoAWkA6gCQQEnALYAXaAycBwBAACAKQlAfAAWABkADgAHwAYgA8ACIAEwAKoAXwAxABmADaAIYARAAjgBRgClAFuAMIAbIBHIC0ALSAXUA6gCHQFsALtAXmAycBwBIACAKQpAoAAWABUADIAHIAPgBBADEAMgAeQBEAEUAJgATwApABVAC-AGIAMwAcwA_ACGAEQAKMAUoAsQBbgDCAGiANkAfoBFgCOAEpALyAh0BJwC2AF2gLzAYaAxgBkgDJygAIAEgApAAA.YAAAAAAAAAAA",
            })
        );
        expect(adsConfig.nonPersonalizedAd).toBe(false);
        // cust_params
        expect(custParams).toEqual(
            expect.objectContaining({
                k: ["economy", "politics", "conservatives", "queens-speech", "uk/uk", "boris-johnson", "tradeunions", "northernireland", "ireland", "eu-referendum", "keir-starmer", "labour"],
                permutive: expect.any(Array),
            })
        );
        // player config
        expect(requestObject).toEqual(
            expect.objectContaining({
                enablejsapi: "1",
                modestbranding: "1",
                origin: "https://www.theguardian.com",
                playsinline: "1",
                rel: "0",
                widgetid: "1"
            })
        );
    });
    it('parses a valid request NOT with consent', () => {
        const request = "https://www.youtube.com/embed/AE0xPBXxFkM?modestbranding=1&origin=https%3A%2F%2Fwww.theguardian.com&playsinline=1&rel=0&embed_config=%7B%22relatedChannels%22%3A%5B%5D%2C%22adsConfig%22%3A%7B%22adTagParameters%22%3A%7B%22iu%22%3A%22%2F59666047%2Ftheguardian.com%2Fpolitics%2Fliveblog%2Fng%22%2C%22cust_params%22%3A%22sens%253Df%2526si%253Df%2526vl%253D0%2526cc%253DUK%2526s%253Dpolitics%2526inskin%253Df%2526se%253Dpolitics-live-with-andrew-sparrow%2526ct%253Dliveblog%2526co%253Dandrewsparrow%252Carchie-bland%252Clisaocarroll%2526url%253D%25252Fpolitics%25252Flive%25252F2022%25252Fmay%25252F10%25252Fminister-says-queens-speech-will-tackle-hooligan-protesters-amid-concerns-non-tory-bills-left-out%2526su%253D4%252C5%252C1%252C2%252C3%2526edition%253Duk%2526tn%253Dminutebyminute%252Cnews%2526p%253Dng%2526k%253Deconomy%252Cpolitics%252Cconservatives%252Cqueens-speech%252Cuk%25252Fuk%252Cboris-johnson%252Ctradeunions%252Cnorthernireland%252Cireland%252Ceu-referendum%252Ckeir-starmer%252Clabour%2526sh%253Dhttps%25253A%25252F%25252Fwww.theguardian.com%25252Fp%25252Fydh4n%2526pa%253Df%2526urlkw%253Dminister%252Csays%252Cqueens%252Cspeech%252Cwill%252Ctackle%252Chooligan%252Cprotesters%252Camid%252Cconcerns%252Cnon%252Ctory%252Cbills%252Cleft%252Cout%2526permutive%253D%22%2C%22cmpGdpr%22%3A1%2C%22cmpGvcd%22%3A%221~%22%2C%22cmpVcd%22%3A%22CPYwK4APYwK4AAGABCENCOCgAAAAAAAAAAwIAAAAAAAA.YAAAAAAAAAAA%22%7D%2C%22nonPersonalizedAd%22%3Atrue%7D%7D&enablejsapi=1&widgetid=1";
        const parsedRequest = parseYouTubeRequest(request);
        const requestObject = JSON.parse(parsedRequest);
        const embedConfig = requestObject.embed_config;
        const adsConfig = embedConfig.adsConfig;
        const adTagParameters = adsConfig.adTagParameters;
        const custParams = adTagParameters.cust_params;
        // consent
        expect(adTagParameters).toEqual(
            expect.objectContaining({
                // cmpGdpr = consentState.tcfv2.gdprApplies
                cmpGdpr: 1,
                // cmpGvcd = consentState.tcfv2.addtlConsent
                cmpGvcd: "1~",
                // cmpVcd = consentState.tcfv2.tcString
                cmpVcd: "CPYwK4APYwK4AAGABCENCOCgAAAAAAAAAAwIAAAAAAAA.YAAAAAAAAAAA",
            })
        );
        expect(adsConfig.nonPersonalizedAd).toBe(true);
        // cust_params
        expect(custParams).toEqual(
            expect.objectContaining({
                k: ["economy", "politics", "conservatives", "queens-speech", "uk/uk", "boris-johnson", "tradeunions", "northernireland", "ireland", "eu-referendum", "keir-starmer", "labour"],
                // TODO is this correct?
                permutive: "",
            })
        );
        // player config
        expect(requestObject).toEqual(
            expect.objectContaining({
                enablejsapi: "1",
                modestbranding: "1",
                origin: "https://www.theguardian.com",
                playsinline: "1",
                rel: "0",
                widgetid: "1"
            })
        );
    });
});

describe('GAM request parser', () => {
    it('parses a valid request with consent', () => {
        const request = "https://securepubads.g.doubleclick.net/gampad/ads?pvsid=873676824876528&correlator=903318301912032&eid=31067486%2C31067418%2C21067496%2C31065518&output=ldjh&gdfp_req=1&vrg=2022050501&ptt=17&impl=fif&gdpr_consent=CPTHoTJPTHoTJAGABCENB-CgAP_AAG_AAAQ4IDtB9S7eTWMDeH5_Y7t0cYUX1R5_oeAijgEAF4IBwRKUIIwWEGAyJESIBqACEAYAIiJAIAdkGEAAAEAAYIABAAHIAEAEKAAAIAIEGAABAgIACAAIAAAAEAAQgAAUECAgiAAAcJYgSAAABAAAAAAAAAgEAAAAAgAAAAAAAAAAAAAAACgbRAhAAcABcAEIAOQAfgBkADQAG0ARwAkQBZgC5AHUAO6Ag4CEAERAJ2AT8ApYBbQC6wGAAYEAzIBrADXwHUAdUA7YB_wEPgJiAXaAxYBtAB4yAOAEwARwBHAEnAJiAWwAvMRAGAEMANkA1gB1QEOgMnEAAQASBIEwACwAKgAZAA5AB4AIAAZAA8gCIAIoATAAngBVADmAHoAPwAhABDACIAEcAJYATQApQBbgDZAHsAPgAfoBAwCOAEpANYAcQBDoCYgFsALzAYaAyQBk4QAEACQApYaAQAIYAbMBaAFpANYAdUBDoDGAGTioBAATABHAEcgLQAtICQQExALYAXmOgaAALAAqABkADkAHwAggBiAGQAPAAfQBEAEUAJgATwAqgBdAC-AGIAMwAcwA9AB-AEMAIgARwAlgBMACaAFGAKUAWIAtwBhADRAGyAPYAfoBAwCLAEcAJTAWgBaQC6gF5AOIAdQBDoCQQFsALtAXmAw0BjADJAGTjgAQAJABSEICwACwAMgAxACYAFUAL4AYgAzAB6AEcALEAYQBHACUwFoAWkA6gCQQEnALYAXaAycBwBAACAKQlAfAAWABkADgAHwAYgA8ACIAEwAKoAXwAxABmADaAIYARAAjgBRgClAFuAMIAbIBHIC0ALSAXUA6gCHQFsALtAXmAycBwBIACAKQpAoAAWABUADIAHIAPgBBADEAMgAeQBEAEUAJgATwApABVAC-AGIAMwAcwA_ACGAEQAKMAUoAsQBbgDCAGiANkAfoBFgCOAEpALyAh0BJwC2AF2gLzAYaAxgBkgDJygAIAEgApAAA.YAAAAAAAAAAA&gdpr=1&addtl_consent=1~46.1301.70.1843.108.1878.440.3119.1097.196.202.89.2918.149.338.1205.2035.415.1415.2677.482.505.494.486.981.1456.89.2090&iu_parts=59666047%2Ctheguardian.com%2Cuk%2Cfront%2Cng&enc_prev_ius=%2F0%2F1%2F2%2F3%2F4&prev_iu_szs=320x50%7C1x1%7C2x2%7C728x90%7C940x230%7C900x250%7C970x250%7C88x71&fluid=height&ifi=1&adks=688616408&sfv=1-0-38&fsbs=1&ecs=20220510&fsapi=false&prev_scp=slot-fabric%3Dfabric1%26slot%3Dtop-above-nav%26id%3D4e60085a-d075-11ec-acad-02c49424d9cb%26vw%3D40%2C50%2C60%2C70%2C80%26vw05%3D40%2C50%2C60%26grm%3D40%2C50%2C60%2C70%2C80%26amznbid%3D2%26amznp%3D2%26hb_format_ozone%3Dbanner%26hb_size_ozone%3D970x250%26hb_pb_ozone%3D0.47%26hb_adid_ozone%3D1559d58edd0be72-2-oz-0%26hb_bidder_ozone%3Dozone%26hb_format_and%3Dbanner%26hb_size_and%3D970x250%26hb_pb_and%3D0.13%26hb_adid_and%3D29d37ac729b5032%26hb_bidder_and%3Dand%26hb_format_ix%3Dbanner%26hb_size_ix%3D970x250%26hb_pb_ix%3D0.46%26hb_adid_ix%3D28cc6d30c4178a8%26hb_bidder_ix%3Dix%26hb_format_improvedig%3Dbanner%26hb_size_improvedigit%3D970x250%26hb_pb_improvedigital%3D0.24%26hb_adid_improvedigit%3D278313c34eb9c6c%26hb_bidder_improvedig%3Dimprovedigital%26hb_format_oxd%3Dbanner%26hb_size_oxd%3D970x250%26hb_pb_oxd%3D0.44%26hb_adid_oxd%3D262d7561d9b1fec%26hb_bidder_oxd%3Doxd%26hb_format_pubmatic%3Dbanner%26hb_size_pubmatic%3D970x250%26hb_pb_pubmatic%3D0.11%26hb_adid_pubmatic%3D25093a53db9ef7%26hb_bidder_pubmatic%3Dpubmatic%26hb_format_criteo%3Dbanner%26hb_size_criteo%3D970x250%26hb_pb_criteo%3D1.38%26hb_adid_criteo%3D6d31547a-acc5-4968-8d2d-2fd378936057%26hb_bidder_criteo%3Dcriteo%26oz_size%3D970x250%26oz_adId%3D1559d58edd0be72-2-oz-0%26oz_pb_r%3D0.47%26oz_pb%3D0.47736%26oz_pb_v%3D2.6.0%26oz_imp_id%3D1559d58edd0be72%26oz_bid%3Dtrue%26oz_winner%3Dpubmatic%26oz_auc_id%3Df4e150be-e23a-444a-b3f1-73fd9997280a%26oz_ozappnexus_sid%3D831%26oz_ozappnexus_pb_r%3D0.06%26oz_ozappnexus_adId%3D1559d58edd0be72-3-oz-0%26oz_ozappnexus_adv%3D211.org%26oz_ozappnexus_crid%3D354263020%26oz_ozappnexus%3Dozappnexus%26oz_pubmatic_pb_r%3D0.47%26oz_pubmatic_adId%3D1559d58edd0be72-2-oz-0%26oz_pubmatic_adv%3Dcottontraders.com%26oz_pubmatic_crid%3D62990_12166%26oz_pubmatic%3Dpubmatic%26oz_openx_pb_r%3D0.13%26oz_openx_adId%3D1559d58edd0be72-1-oz-0%26oz_openx_adv%3Detoro.com%26oz_openx_crid%3D4378723%26oz_openx%3Dopenx%26oz_appnexus_pb_r%3D0.13%26oz_appnexus_adId%3D1559d58edd0be72-0-oz-0%26oz_appnexus_adv%3Dmicrosoft.com%26oz_appnexus_crid%3D297801787%26oz_appnexus%3Dappnexus%26hb_pid%3D1116397%26hb_format%3Dbanner%26hb_size%3D970x250%26hb_pb%3D1.38%26hb_adid%3D6d31547a-acc5-4968-8d2d-2fd378936057%26hb_bidder%3Dcriteo&cust_params=permutive%3D23527%252C24083%252C24089%252C24091%252C24495%252C24509%252C24525%252C24538%252C24558%252C24561%252C24565%252C24566%252C24571%252C24581%252C24583%252C24594%252C24599%252C24601%252C24603%252C24604%252C24605%252C24607%252C24608%252C24611%252C24612%252C24615%252C24616%252C24618%252C24619%252C24624%252C24627%252C24632%252C24633%252C24639%252C24645%252C24646%252C24647%252C24650%252C24652%252C24654%252C24655%252C24656%252C24657%252C24658%252C24659%252C24661%252C24676%252C24677%252C24678%252C24679%252C24680%252C24682%252C24684%252C24686%252C24688%252C24689%252C24690%252C24691%252C24692%252C24693%252C24694%252C24695%252C24699%252C24753%252C24757%252C24763%252C24977%252C24983%252C24984%252C24985%252C25031%252C25061%252C25079%252C25086%252C25180%252C25367%252C25457%252C25471%252C25472%252C25480%252C25484%252C25500%252C26030%252C26130%252C26419%252C26534%252C26749%252C26822%252C27564%252C27592%252C27631%252C28008%252C28478%252C28479%252C28985%252C29249%252C29317%252C29431%252C31044%252C31207%252C31250%252C31251%252C31757%252C31954%252C32322%252C32328%252C32388%252C32484%252C32510%252C32737%252C32738%252C32773%252C33126%252C33129%252C33379%252C33392%252C34312%252C34372%252C37158%252C37344%252C37434%252C37673%252C37751%252C38185%252C39636%252C39994%252C39996%252C40032%252C40123%252C40192%252C40205%252C40271%252C40273%252C40852%252C40961%252C40986%252C42134%252C42135%252C42233%252C43270%252C43272%252C43599%252C43850%252C47026%252C47509%252C47834%252C48018%252C49820%252C50447%252C50932%252C51653%252C52501%252C52698%252C52945%252C52946%252C53104%252C53220%252C53278%252C53290%252C53293%252C53301%252C53793%252C54438%252C54565%252C54759%252C54952%252C55191%252C55237%252C56521%252C56617%252C56792%252C56848%252C57824%252C59453%252C59934%252C60110%252C60164%252C60459%252C60460%252C60722%252C60835%252C60906%252C61623%252C61624%252C61625%252C62154%252C62176%252C62177%252C62332%252C62597%252C62605%252C64286%252C64482%252C64816%252C64866%252C64932%252C66587%252C66654%252C66655%252C67162%252C67163%252C69195%252C69480%252C70011%252C71154%252C73168%252C73169%252C73177%252C74853%252C75241%252C75539%252C75590%252C75667%252C75977%252C76330%252C76453%252C77558%252C77562%252C77683%252C77872%252C79104%252C79116%252C79204%252C79231%252C79492%252C80376%252C80377%252C81084%252C81511%252C81541%252C81748%252C81809%252C81826%252C82082%252C82083%252C82086%252C82087%252C82091%252C82093%252C82098%252C82349%252C82400%252C82401%252C82404%252C82405%252C82406%252C82407%252C82408%252C82409%252C82417%252C82418%252C82429%252C82437%252C82451%252C82453%252C82457%252C82459%252C82461%252C82463%252C82465%252C82468%252C83113%252C83506%252C83587%252C83589%252C83638%252C83639%252C84489%252C84887%252C84889%252C86009%252C86179%252C86180%252C86181%252C87064%252C87475%252C87476%252C88337%252C88411%252C88612%252C88625%252C88693%252C88756%252C88861%252C89723%252C90006%252C90073%252C90081%252C90373%252C90412%252C90779%252C91178%252C91323%252C93452%252C93540%252C94425%252C94623%252C96424%252C97872%252C98022%252C98023%252C98025%252C98028%252C98368%252C98817%252C99772%252C100574%252C100576%252C103179%252C41547%252C41548%252C41549%252C41550%252C52701%252C52702%252C52703%252Crts%26fr%3D30plus%26amtgrp%3D5%26cmp_interaction%3Dtcloaded%26consent_tcfv2%3Dt%26pa%3Dt%26rdp%3Dna%26ct%3Dnetwork-front%26url%3D%252Fuk%26edition%3Duk%26p%3Dng%26k%3Duk%26dcre%3Df%26rp%3Ddotcom-platform%26s%3Duk%26sens%3Df%26urlkw%3Duk%26ab%3DSignInGateMainVariant-main-variant-4%252Cinline1ContainerSizingVariant-variant%26at%3Dteadspassback2022%26cc%3DGB%26pv%3Dl30b05ybsyiun9gdkj4s%26si%3Df%26bp%3Ddesktop%26skinsize%3Dl%26inskin%3Dt%26adt%3DveryLow%26alc%3DveryLow%26dlm%3DveryLow%26drg%3Dlow%26hat%3DveryLow%26off%3DveryLow%26vio%3Dlow%26fra%3Dfalse%26ias-kw%3DIAS_3006644_PG%252CIAS_1500692_PG%252CIAS_1500903_PG%252CIAS_1508646_PG%252CIAS_1507473_PG%252CIAS_1500902_PG%252CIAS_1506436_PG%252CIAS_1507653_PG&sc=1&cookie=ID%3D9c4c18c0548e76a1%3AT%3D1649154484%3AS%3DALNI_MYAG458JjuOnjLWTDeuTjh3m54JVQ&abxe=1&dt=1652196280295&lmt=1652196280&dlt=1652196276427&idt=2158&biw=1579&bih=1666&adxs=789&adys=26&ucis=1&oid=2&u_his=2&u_h=1800&u_w=3200&u_ah=1777&u_aw=3158&u_cd=24&u_sd=2&u_tz=60&dmc=8&bc=31&uach=WyJtYWNPUyIsIjEwLjE1LjciLCJ4ODYiLCIiLCIxMDEuMC40OTUxLjU0IixbXSxudWxsLG51bGwsIjY0IixbWyIgTm90IEE7QnJhbmQiLCI5OS4wLjAuMCJdLFsiQ2hyb21pdW0iLCIxMDEuMC40OTUxLjU0Il0sWyJHb29nbGUgQ2hyb21lIiwiMTAxLjAuNDk1MS41NCJdXSxmYWxzZV0.&nvt=2&url=https%3A%2F%2Fwww.theguardian.com%2Fuk&frm=20&vis=1&scr_x=0&scr_y=2&psz=1579x133&msz=2x90&fws=516&ohw=1579&ga_vid=710358951.1649169205&ga_sid=1652196280&ga_hid=1906071566&ga_fc=true&btvi=0&tt_state=W3siaXNzdWVyT3JpZ2luIjoiaHR0cHM6Ly9wYWdlYWQyLmdvb2dsZXN5bmRpY2F0aW9uLmNvbSIsInN0YXRlIjoxNiwiaGFzUmVkZW1wdGlvblJlY29yZCI6ZmFsc2V9XQ..&topics=1";
        const parsedRequest = parseGAMRequest(request);
        const requestObject = JSON.parse(parsedRequest);
        const custParams = requestObject.cust_params;
        // consent
        expect(requestObject).toEqual(
            expect.objectContaining({
                // addtl_consent = consentState.tcfv2.addtlConsent
                addtl_consent: "1~46.1301.70.1843.108.1878.440.3119.1097.196.202.89.2918.149.338.1205.2035.415.1415.2677.482.505.494.486.981.1456.89.2090",
                cmp_interaction: "tcloaded",
                consent_tcfv2: "t",
                // gdpr = consentState.tcfv2.gdprApplies
                gdpr: "1",
                // gdpr_consent = consentState.tcfv2.tcString
                gdpr_consent: "CPTHoTJPTHoTJAGABCENB-CgAP_AAG_AAAQ4IDtB9S7eTWMDeH5_Y7t0cYUX1R5_oeAijgEAF4IBwRKUIIwWEGAyJESIBqACEAYAIiJAIAdkGEAAAEAAYIABAAHIAEAEKAAAIAIEGAABAgIACAAIAAAAEAAQgAAUECAgiAAAcJYgSAAABAAAAAAAAAgEAAAAAgAAAAAAAAAAAAAAACgbRAhAAcABcAEIAOQAfgBkADQAG0ARwAkQBZgC5AHUAO6Ag4CEAERAJ2AT8ApYBbQC6wGAAYEAzIBrADXwHUAdUA7YB_wEPgJiAXaAxYBtAB4yAOAEwARwBHAEnAJiAWwAvMRAGAEMANkA1gB1QEOgMnEAAQASBIEwACwAKgAZAA5AB4AIAAZAA8gCIAIoATAAngBVADmAHoAPwAhABDACIAEcAJYATQApQBbgDZAHsAPgAfoBAwCOAEpANYAcQBDoCYgFsALzAYaAyQBk4QAEACQApYaAQAIYAbMBaAFpANYAdUBDoDGAGTioBAATABHAEcgLQAtICQQExALYAXmOgaAALAAqABkADkAHwAggBiAGQAPAAfQBEAEUAJgATwAqgBdAC-AGIAMwAcwA9AB-AEMAIgARwAlgBMACaAFGAKUAWIAtwBhADRAGyAPYAfoBAwCLAEcAJTAWgBaQC6gF5AOIAdQBDoCQQFsALtAXmAw0BjADJAGTjgAQAJABSEICwACwAMgAxACYAFUAL4AYgAzAB6AEcALEAYQBHACUwFoAWkA6gCQQEnALYAXaAycBwBAACAKQlAfAAWABkADgAHwAYgA8ACIAEwAKoAXwAxABmADaAIYARAAjgBRgClAFuAMIAbIBHIC0ALSAXUA6gCHQFsALtAXmAycBwBIACAKQpAoAAWABUADIAHIAPgBBADEAMgAeQBEAEUAJgATwApABVAC-AGIAMwAcwA_ACGAEQAKMAUoAsQBbgDCAGiANkAfoBFgCOAEpALyAh0BJwC2AF2gLzAYaAxgBkgDJygAIAEgApAAA.YAAAAAAAAAAA",
            })
        );
        // cust_params
        expect(custParams).toEqual(
            expect.objectContaining({
                permutive: expect.any(Array),
            })
        );
        // targeting
        expect(requestObject).toEqual(
            expect.objectContaining({
                hb_pb: "1.38",
                slot: "top-above-nav",
                url: "https://www.theguardian.com/uk",
                urlkw: "uk",
            })
        );
    });
});
